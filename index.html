<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":5,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="正在进化">
<meta property="og:type" content="website">
<meta property="og:title" content="拼图收集者">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="拼图收集者">
<meta property="og:description" content="正在进化">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Fushen Ban">
<meta property="article:tag" content="linux，golang，lua，c，python，nodejs，k8s，redis">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>拼图收集者</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">拼图收集者</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">欠的技术债，早晚都要还</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/29/%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/29/%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E8%BF%9B%E7%A8%8B%E5%8D%A0%E7%94%A8%E7%9A%84%E5%86%85%E5%AD%98/" class="post-title-link" itemprop="url">如何查看进程占用的内存</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-29 22:22:45" itemprop="dateCreated datePublished" datetime="2022-05-29T22:22:45+08:00">2022-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:15" itemprop="dateModified" datetime="2023-07-16T17:11:15+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%9F%BA%E6%9C%AC%E5%8A%9F/" itemprop="url" rel="index"><span itemprop="name">后端开发基本功</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<h1 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h1><p><code>top -P pid</code>，其中RSS为进程当前使用的内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">top - 22:18:50 up 163 days,  5:48, 64 <span class="built_in">users</span>,  load average: 0.88, 1.07, 1.45</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s):  1.5 us,  0.9 sy,  0.0 ni, 97.3 <span class="built_in">id</span>,  0.0 wa,  0.0 hi,  0.0 si,  0.3 st</span><br><span class="line">KiB Mem : 32950160 total,  3186404 free, 19244656 used, 10519100 buff/cache</span><br><span class="line">KiB Swap:  2097148 total,  1736340 free,   360808 used. 12881604 avail Mem</span><br><span class="line"></span><br><span class="line">    PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">1696650 banfush+  20   0  712796 100940  29096 S  11.3  0.3   7659:06 node</span><br></pre></td></tr></table></figure>
<h1 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h1><p><code>cat /proc/pid/status</code>其中VMRSS为进程使用内存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">banfushen@ma100:~/$ <span class="built_in">cat</span> /proc/1696650/status</span><br><span class="line">Name:   node</span><br><span class="line">Umask:  0022</span><br><span class="line">State:  S (sleeping)</span><br><span class="line">Tgid:   1696650</span><br><span class="line">Ngid:   0</span><br><span class="line">Pid:    1696650</span><br><span class="line">PPid:   1696531</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    50301   50301   50301   50301</span><br><span class="line">Gid:    50301   50301   50301   50301</span><br><span class="line">FDSize: 128</span><br><span class="line">Groups: 0 4 999 50301</span><br><span class="line">NStgid: 1696650</span><br><span class="line">NSpid:  1696650</span><br><span class="line">NSpgid: 245413</span><br><span class="line">NSsid:  245413</span><br><span class="line">VmPeak:   715100 kB</span><br><span class="line">VmSize:   712796 kB</span><br><span class="line">VmLck:         0 kB</span><br><span class="line">VmPin:         0 kB</span><br><span class="line">VmHWM:    121080 kB</span><br><span class="line">VmRSS:    100444 kB</span><br><span class="line">RssAnon:           71348 kB</span><br><span class="line">RssFile:           29096 kB</span><br><span class="line">RssShmem:              0 kB</span><br><span class="line">VmData:   148608 kB</span><br><span class="line">VmStk:       132 kB</span><br><span class="line">VmExe:     63804 kB</span><br><span class="line">VmLib:      5308 kB</span><br><span class="line">VmPTE:      1300 kB</span><br><span class="line">VmPMD:      1076 kB</span><br><span class="line">VmSwap:        0 kB</span><br><span class="line">HugetlbPages:          0 kB</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/" class="post-title-link" itemprop="url">Ubuntu 18.04.3 安装redis，配置端口与密码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-05-08 16:50:36 / 修改时间：22:51:46" itemprop="dateCreated datePublished" datetime="2022-05-08T16:50:36+08:00">2022-05-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Ubuntu-18-04-3-安装redis，配置端口与密码"><a href="#Ubuntu-18-04-3-安装redis，配置端口与密码" class="headerlink" title="Ubuntu 18.04.3 安装redis，配置端口与密码"></a>Ubuntu 18.04.3 安装redis，配置端口与密码</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><code>sudo apt-get install redis-server</code></p>
<h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><p><code>ps -aux | grep redis</code><br><img src="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/803319237335.png" alt></p>
<h2 id="修改端口"><a href="#修改端口" class="headerlink" title="修改端口"></a>修改端口</h2><p><code>sudo subl /etc/redis/redis.conf</code>，改为自己想要的端口。<br><img src="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/1589519230469.png" alt></p>
<h2 id="重启redis"><a href="#重启redis" class="headerlink" title="重启redis"></a>重启redis</h2><p><code>sudo service redis-server restart</code><br><code>ps -aux | grep redis</code><br><img src="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/2428019220999.png" alt></p>
<h2 id="密码修改"><a href="#密码修改" class="headerlink" title="密码修改"></a>密码修改</h2><p>继续修改<code>/etc/redis/redis.conf</code>，找到一个  # requirepass foobared  的字段将这个字段的注释取消掉，这个字段是数据的访问密码，将foobared替换成自己想要设置的密码。<br><img src="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/3274819223503.png" alt><br>修改后重启redis，<code>sudo service redis-server restart</code><br><img src="/2022/05/08/Ubuntu-18-04-3-%E5%AE%89%E8%A3%85redis%EF%BC%8C%E9%85%8D%E7%BD%AE%E7%AB%AF%E5%8F%A3%E4%B8%8E%E5%AF%86%E7%A0%81/3825619232450.png" alt></p>
<p>sbul是我装了sublime text之后的编辑器，如果没有安装，将subl换成vi/vim即可。我自己通过以上方式，已能修改，做次记录。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/04/%E6%90%AC%E8%BF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/04/%E6%90%AC%E8%BF%81/" class="post-title-link" itemprop="url">搬迁</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-05-04 21:56:10" itemprop="dateCreated datePublished" datetime="2022-05-04T21:56:10+08:00">2022-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-05-08 22:57:27" itemprop="dateModified" datetime="2022-05-08T22:57:27+08:00">2022-05-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2022-5-4"><a href="#2022-5-4" class="headerlink" title="2022.5.4"></a>2022.5.4</h1><p>计划将csnd的博客全部搬到github</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/23934523">搭建参考</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/unirithe/p/15530636.html">无法显示图片解决</a>，放入图片后要进行<code>hexo clean, hexo g, hexo s</code>即可在本地启动中看到</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/16/kubernetes%20cluster%20autoscale%20%E4%B8%8D%E4%BC%9A%E5%88%A0%E9%99%A4nodes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/16/kubernetes%20cluster%20autoscale%20%E4%B8%8D%E4%BC%9A%E5%88%A0%E9%99%A4nodes/" class="post-title-link" itemprop="url">kubernetes cluster autoscale 不会删除nodes</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-16 14:39:34" itemprop="dateCreated datePublished" datetime="2022-04-16T14:39:34+08:00">2022-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:15" itemprop="dateModified" datetime="2023-07-16T17:11:15+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p>项目上线后，通过<code>kubectl top</code> node，发现有的node上使用的资源非常少，<code>kubectl describe node</code> 发现完全可以驱逐。但是cluster autoscaler缺没有驱逐。</p>
<p>按照官方的说法<br><img src="https://img-blog.csdnimg.cn/a4b1a9d504e14982a6a3d10099797bbe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQmFuRlM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>检查了node上的pod，没发现有什么pod满足以上。<br>查看cluster autoscaler的日志<br><img src="https://img-blog.csdnimg.cn/7cabdae5acf3437fb40eed34249bcf19.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQmFuRlM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>gitlab runner原来装在kube-system namespace下，最后把node上的gitlab runner删除，node即可被驱逐，猜测gitlab runner可能满足了以下导致。<br><img src="https://img-blog.csdnimg.cn/aaff910d278f47a2940968bf3a257dd0.png" alt="在这里插入图片描述"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/13/perf%E5%AF%B9%E5%A4%9A%E7%BA%BF%E7%A8%8BProfile%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/13/perf%E5%AF%B9%E5%A4%9A%E7%BA%BF%E7%A8%8BProfile%E7%AE%80%E5%8D%95%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">perf对多线程Profile简单流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-13 20:48:52" itemprop="dateCreated datePublished" datetime="2022-02-13T20:48:52+08:00">2022-02-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:15" itemprop="dateModified" datetime="2023-07-16T17:11:15+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">Linux 性能优化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><p>Perf是用于软件性能分析的工具，通过Perf，应用程序可以利用PMU，tracepoint和内核中的特殊计数器进行性能统计。Perf不但可以分析应用程序的性能问题(per thread)，也可以分析内核的性能问题，处理所有性能相关的事件：程序运行期间的硬件事件，如instructions retired ，processor clock cycles等；软件事件，如Page Fault和进程切换。</p>
<p>Perf基本原理是对被监测对象进行采样，最简单的情形是根据tick中断进行采样，即在tick中断内触发采样点，在采样点里判断程序当前的上下文。假如一个程序90%的时间都花费在函数func1()上，那么90%的采样点都应该落在函数func1()的上下文中，采样时间越长，上述推论越可靠。<strong>使用perf要有管理员权限</strong></p>
<h2 id="使用perf对多线程进行profile"><a href="#使用perf对多线程进行profile" class="headerlink" title="使用perf对多线程进行profile"></a>使用perf对多线程进行profile</h2><h3 id="准备多线程程序"><a href="#准备多线程程序" class="headerlink" title="准备多线程程序"></a>准备多线程程序</h3><p>在此程序中，创建了两个线程。分别跑了不同次数的func1()方法。<code>gcc -lpthread main.c</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> thread[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10000</span>)</span><br><span class="line">        ++i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i&lt;<span class="number">10000</span>)</span><br><span class="line">        i = i*<span class="number">2</span>;</span><br><span class="line">    func1();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            func1();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            func2();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">thread_create</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> temp;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;thread, <span class="number">0</span>, <span class="keyword">sizeof</span>(thread));</span><br><span class="line">        <span class="keyword">if</span>((temp = pthread_create(&amp;thread[<span class="number">0</span>], <span class="literal">NULL</span>, thread1, <span class="literal">NULL</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;线程1创建失败!\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;线程1被创建\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>((temp = pthread_create(&amp;thread[<span class="number">1</span>], <span class="literal">NULL</span>, thread2, <span class="literal">NULL</span>)) != <span class="number">0</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;线程2创建失败\n&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;线程2被创建\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">        thread_create();</span><br><span class="line">        pthread_join(thread[<span class="number">0</span>],<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;线程1加入&quot;</span>);</span><br><span class="line">        pthread_join(thread[<span class="number">1</span>],<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;线程2加入&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="使用perf对程序进行采样"><a href="#使用perf对程序进行采样" class="headerlink" title="使用perf对程序进行采样"></a>使用perf对程序进行采样</h3><h4 id="对还没启动的程序"><a href="#对还没启动的程序" class="headerlink" title="对还没启动的程序"></a>对还没启动的程序</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ma100:/home/banfushen/perf_cpu/multi_thread# perf record -h</span><br><span class="line">Usage: perf record [&lt;options&gt;] [&lt;command&gt;]</span><br><span class="line">    or: perf record [&lt;options&gt;] -- &lt;command&gt; [&lt;options&gt;]</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    -F, --freq &lt;n&gt;        profile at this frequency</span><br><span class="line">    -g                    enables call-graph recording</span><br><span class="line">    -p, --pid &lt;pid&gt;       record events on existing process id</span><br><span class="line">    -t, --tid &lt;tid&gt;       record events on existing thread id</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p><code>perf record -g -F 99 ./a.out</code>，对多线程程序进行采样，采样频率99，(-F 99: sample at 99 Hertz (samples per second). I’ll sometimes sample faster than this (up to 999 Hertz), but that also costs overhead. 99 Hertz should be negligible. Also, the value ‘99’ and not ‘100’ is to avoid lockstep sampling, which can produce skewed results.)。运行完毕会得到一个<code>perf.data</code>，要想得到火焰图，还需要借助别的工具。</p>
<h4 id="对已经启动的程序"><a href="#对已经启动的程序" class="headerlink" title="对已经启动的程序"></a>对已经启动的程序</h4><p>对于已经启动的程序，要拿到pid，<code>perf record -g -F 99 -p &lt;pid&gt;</code></p>
<h3 id="下载工具FlameGraph"><a href="#下载工具FlameGraph" class="headerlink" title="下载工具FlameGraph"></a>下载工具FlameGraph</h3><p><code>git clone https://github.com/brendangregg/FlameGraph.git</code><br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">banfushen@ma100:~/perf_cpu/FlameGraph$ pwd</span><br><span class="line">/home/banfushen/perf_cpu/FlameGraph</span><br></pre></td></tr></table></figure></p>
<h3 id="生成火焰图"><a href="#生成火焰图" class="headerlink" title="生成火焰图"></a>生成火焰图</h3><h4 id="对perf-data生成火焰图-按照上面来说就是一个进程的"><a href="#对perf-data生成火焰图-按照上面来说就是一个进程的" class="headerlink" title="对perf.data生成火焰图(按照上面来说就是一个进程的)"></a>对perf.data生成火焰图(按照上面来说就是一个进程的)</h4><p><code>perf script |/home/banfushen/perf_cpu/FlameGraph/stackcollapse-perf.pl|/home/banfushen/perf_cpu/FlameGraph/flamegraph.pl &gt; output.svg</code><br><img src="https://img-blog.csdnimg.cn/cedfefcf300a468b9c32fc84ffc19bfb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQmFuRlM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="\[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-68Nci8QI-1644756192593)(_v_images/20211214172626556_19376.png)\]"></p>
<h4 id="对单个线程生成火焰图"><a href="#对单个线程生成火焰图" class="headerlink" title="对单个线程生成火焰图"></a>对单个线程生成火焰图</h4><p>要知道线程id<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@ma100:/home/banfushen/perf_cpu/multi_thread# perf script -h</span><br><span class="line"></span><br><span class="line"> Usage: perf script [&lt;options&gt;]</span><br><span class="line">    or: perf script [&lt;options&gt;] record &lt;script&gt; [&lt;record-options&gt;] &lt;command&gt;</span><br><span class="line">    or: perf script [&lt;options&gt;] report &lt;script&gt; [script-args]</span><br><span class="line">    or: perf script [&lt;options&gt;] &lt;script&gt; [&lt;record-options&gt;] &lt;command&gt;</span><br><span class="line">    or: perf script [&lt;options&gt;] &lt;top-script&gt; [script-args]</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    -v, --verbose         be more verbose (show symbol address, etc)</span><br><span class="line">        --pid &lt;pid[,pid...]&gt;</span><br><span class="line">        --tid &lt;tid[,tid...]&gt;</span><br><span class="line">                          only consider symbols in these tids</span><br></pre></td></tr></table></figure><br><code>perf script -v --tid &lt;tid&gt; 指定线程</code><br><code>perf script -v --tid 2283471|/home/banfushen/perf_cpu/FlameGraph/stackcollapse-perf.pl|/home/banfushen/perf_cpu/FlameGraph/flamegraph.pl &gt; output1.svg</code><br><img src="https://img-blog.csdnimg.cn/db320151507f4c3a8ecb2e5258e0e704.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQmFuRlM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="\[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-UAKuRRSC-1644756192594)(_v_images/20211214172949738_20703.png)\]"></p>
<h4 id="对多个线程生成火焰图"><a href="#对多个线程生成火焰图" class="headerlink" title="对多个线程生成火焰图"></a>对多个线程生成火焰图</h4><p><code>perf script -v --tid &lt;tid[,tid...]&gt; 指定多个线程</code><br><code>perf script -v --tid 2283472,2283471|/home/banfushen/perf_cpu/FlameGraph/stackcollapse-perf.pl|/home/banfushen/perf_cpu/FlameGraph/flamegraph.pl &gt; output3.svg</code><br><img src="https://img-blog.csdnimg.cn/6fbc37032b3c4efba64387ab5f115c22.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAQmFuRlM=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="\[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-y7qrS028-1644756192595)(_v_images/20211214173120899_8466.png)\]"><br>参考资料:<br><a target="_blank" rel="noopener" href="https://www.brendangregg.com/perf.html">perf Examples</a><br><a target="_blank" rel="noopener" href="https://melonshell.github.io/2019/10/09/tool1_perf/">perf性能分析</a><br><a target="_blank" rel="noopener" href="http://walkerdu.com/2018/09/13/perf-event/">性能分析利器之perf浅析</a><br><a target="_blank" rel="noopener" href="https://blog.gmem.cc/perf">利用perf剖析Linux应用程序</a><br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000021465563">Linux性能分析工具Perf简介</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/redis%20cluster%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC%E7%9A%84%E5%9D%91%EF%BC%8C%E9%9D%9E%E5%90%8C%E4%B8%80%E4%B8%AAslot%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/redis%20cluster%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC%E7%9A%84%E5%9D%91%EF%BC%8C%E9%9D%9E%E5%90%8C%E4%B8%80%E4%B8%AAslot%E4%B9%9F%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8lua%E8%84%9A%E6%9C%AC/" class="post-title-link" itemprop="url">redis cluster使用lua脚本的坑，非同一个slot也可以使用lua脚本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 21:09:51" itemprop="dateCreated datePublished" datetime="2022-02-10T21:09:51+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:17" itemprop="dateModified" datetime="2023-07-16T17:11:17+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/lua-redis/" itemprop="url" rel="index"><span itemprop="name">lua redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p>在项目中，需要用lua脚本操作redis cluster中的多个key，但是非同slot的时候会报错，例如下面test3、test6在同一个node，但是却不是同一个slot。redis使用lua脚本可以这样<code>redis-cli -a xxxxx--eval demo.lua key1 key2 , val1 val2</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">banfushen@ma100:~/redis-cluster$ redis-cli -p 16380 -c</span><br><span class="line">192.168.88.7:6379&gt; <span class="built_in">set</span> test3 3333</span><br><span class="line">-&gt; Redirected to slot [13026] located at 192.168.88.3:6379</span><br><span class="line">OK</span><br><span class="line">192.168.88.6:6379&gt; <span class="built_in">set</span> test5 3333</span><br><span class="line">-&gt; Redirected to slot [4644] located at 192.168.88.5:6379</span><br><span class="line">OK</span><br><span class="line">192.168.88.5:6379&gt; <span class="built_in">set</span> test6 3333</span><br><span class="line">-&gt; Redirected to slot [8775] located at 192.168.88.3:6379</span><br><span class="line">OK</span><br><span class="line">192.168.88.3:6379&gt; cluster keyslot test3</span><br><span class="line">(<span class="built_in">integer</span>) 13026</span><br><span class="line">192.168.88.3:6379&gt; cluster keyslot test6</span><br><span class="line">(<span class="built_in">integer</span>) 8775</span><br><span class="line">192.168.88.3:6379&gt;</span><br></pre></td></tr></table></figure></p>
<h1 id="通过key传入"><a href="#通过key传入" class="headerlink" title="通过key传入"></a>通过key传入</h1><p>一般在redis cluster中使用lua脚本，会碰到<code>(error) CROSSSLOT Keys in request don&#39;t hash to the same slot</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">banfushen@ma100:~/test$ <span class="built_in">cat</span> get.lua</span><br><span class="line"><span class="built_in">local</span> key1 = KEYS[1]</span><br><span class="line"><span class="built_in">local</span> key1 = KEYS[2]</span><br><span class="line"></span><br><span class="line"><span class="built_in">local</span> value1 = redis.call(<span class="string">&quot;GET&quot;</span>, key1)</span><br><span class="line"><span class="built_in">local</span> value2 = redis.call(<span class="string">&quot;GET&quot;</span>, key2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">return</span> &#123;value1, value2&#125;</span><br><span class="line">banfushen@ma100:~/test$  redis-cli -p 16380 -c --<span class="built_in">eval</span> get.lua test3 test6</span><br><span class="line">(error) CROSSSLOT Keys <span class="keyword">in</span> request don<span class="string">&#x27;t hash to the same slot</span></span><br></pre></td></tr></table></figure></p>
<h1 id="通过value传入"><a href="#通过value传入" class="headerlink" title="通过value传入"></a>通过value传入</h1><p>在官方的说明中，redis 使用lua脚本是限制在用一个node上使用的，可是这里明明是同一个node，却无法使用，但是如果我们把脚本改成下面这样</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">banfushen@ma100:~/test$ <span class="built_in">cat</span> get.lua</span><br><span class="line"><span class="built_in">local</span> key1 = ARGV[1]</span><br><span class="line"><span class="built_in">local</span> key2 = ARGV[2]</span><br><span class="line"></span><br><span class="line"><span class="built_in">local</span> value1 = redis.call(<span class="string">&quot;GET&quot;</span>, key1)</span><br><span class="line"><span class="built_in">local</span> value2 = redis.call(<span class="string">&quot;GET&quot;</span>, key2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">return</span> &#123;value1, value2&#125;</span><br><span class="line">banfushen@ma100:~/test$ redis-cli -p 16380 -c --<span class="built_in">eval</span> get.lua  , test6 test3</span><br><span class="line">1) <span class="string">&quot;3333&quot;</span></span><br><span class="line">2) <span class="string">&quot;3333&quot;</span></span><br></pre></td></tr></table></figure>
<p>这样即可解决。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>应该是按照KEY传入的时候，redis为了防止key不在同一个node上，对key进行slot判断，如果不是同一个slot就直接返回了，但是是支持同一个node的，<strong>只要我们对我们需要操作的key进行分类，同一个node的key通过value传入，即可在lua脚本中对同一个node的key操作。</strong>在我们设计redis cluster的时候，是知道每个node的slot的，每个key的solt可以使用以下计算<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.88.3:6379&gt; cluster keyslot test3</span><br><span class="line">(<span class="built_in">integer</span>) 13026</span><br></pre></td></tr></table></figure><br>我们只需要先判断slot在某个范围内，属于一个node，即可进行批量操作。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/redis%20cluster%20%E6%9F%A5%E7%9C%8B%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84slot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/redis%20cluster%20%E6%9F%A5%E7%9C%8B%E5%90%84%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84slot/" class="post-title-link" itemprop="url">redis cluster 查看各个节点的slot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 20:38:56" itemprop="dateCreated datePublished" datetime="2022-02-10T20:38:56+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:15" itemprop="dateModified" datetime="2023-07-16T17:11:15+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p><code>redis-cli -p xxxx -c cluster nodes</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/%E5%A6%82%E4%BD%95%E5%9C%A8linux%E4%B8%AD%E9%80%9A%E8%BF%87linux%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%9A%84perf%EF%BC%8C%E4%BD%BF%E7%94%A8perf%20data%20convert%20--force%20--to-json/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/%E5%A6%82%E4%BD%95%E5%9C%A8linux%E4%B8%AD%E9%80%9A%E8%BF%87linux%E6%BA%90%E7%A0%81%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%9A%84perf%EF%BC%8C%E4%BD%BF%E7%94%A8perf%20data%20convert%20--force%20--to-json/" class="post-title-link" itemprop="url">如何在linux中通过linux源码安装最新的perf，使用perf data convert --force --to-json</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 20:25:42" itemprop="dateCreated datePublished" datetime="2022-02-10T20:25:42+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:17" itemprop="dateModified" datetime="2023-07-16T17:11:17+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" itemprop="url" rel="index"><span itemprop="name">Linux 性能优化</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p>perf可以针对进程进行profile，也可以对线程进行profile。再对进程profile之后，拿到perf.data，也可以修改为针对进程下的线程进行profile。所以照理来说应该是可以从perf.data中查看到有多少线程。<br>这也符合我们的一般要求，即有perf.data之后，可以针对线程显示火焰图。经过查询资料发现，perf中有<code>perf data convert --force --to-json temp.json</code>可以把perf.data转成json进行查看，但是要新版本的perf才有…这就恨坑爹，以为着我们需要自己安装最新的perf。</p>
<h1 id="安装perf"><a href="#安装perf" class="headerlink" title="安装perf"></a>安装perf</h1><p>我的系统是RedHat系列，对应的Debian系列需要自己修改一下install相关。<br>拉取最新的内核代码<code>git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git --depth 1000</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-155-128-114 ~]<span class="comment"># cd linux/tools/perf/</span></span><br><span class="line">[root@ip-10-155-128-114 perf]<span class="comment"># LIBBABELTRACE=1 LIBBABELTRACE_DIR=/usr/local  make</span></span><br><span class="line">  BUILD:   Doing <span class="string">&#x27;make -j2&#x27;</span> parallel build</span><br><span class="line">  HOSTCC  fixdep.o</span><br><span class="line">  HOSTLD  fixdep-in.o</span><br><span class="line">  LINK    fixdep</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/include/uapi/linux/kvm.h&#x27;</span> differs from latest version at <span class="string">&#x27;include/uapi/linux/kvm.h&#x27;</span></span><br><span class="line">diff -u tools/include/uapi/linux/kvm.h include/uapi/linux/kvm.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/include/uapi/linux/perf_event.h&#x27;</span> differs from latest version at <span class="string">&#x27;include/uapi/linux/perf_event.h&#x27;</span></span><br><span class="line">diff -u tools/include/uapi/linux/perf_event.h include/uapi/linux/perf_event.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/include/uapi/linux/prctl.h&#x27;</span> differs from latest version at <span class="string">&#x27;include/uapi/linux/prctl.h&#x27;</span></span><br><span class="line">diff -u tools/include/uapi/linux/prctl.h include/uapi/linux/prctl.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/include/uapi/sound/asound.h&#x27;</span> differs from latest version at <span class="string">&#x27;include/uapi/sound/asound.h&#x27;</span></span><br><span class="line">diff -u tools/include/uapi/sound/asound.h include/uapi/sound/asound.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/arch/x86/include/asm/cpufeatures.h&#x27;</span> differs from latest version at <span class="string">&#x27;arch/x86/include/asm/cpufeatures.h&#x27;</span></span><br><span class="line">diff -u tools/arch/x86/include/asm/cpufeatures.h <span class="built_in">arch</span>/x86/include/asm/cpufeatures.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/arch/x86/include/uapi/asm/prctl.h&#x27;</span> differs from latest version at <span class="string">&#x27;arch/x86/include/uapi/asm/prctl.h&#x27;</span></span><br><span class="line">diff -u tools/arch/x86/include/uapi/asm/prctl.h <span class="built_in">arch</span>/x86/include/uapi/asm/prctl.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/include/uapi/asm-generic/unistd.h&#x27;</span> differs from latest version at <span class="string">&#x27;include/uapi/asm-generic/unistd.h&#x27;</span></span><br><span class="line">diff -u tools/include/uapi/asm-generic/unistd.h include/uapi/asm-generic/unistd.h</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/perf/arch/x86/entry/syscalls/syscall_64.tbl&#x27;</span> differs from latest version at <span class="string">&#x27;arch/x86/entry/syscalls/syscall_64.tbl&#x27;</span></span><br><span class="line">diff -u tools/perf/arch/x86/entry/syscalls/syscall_64.tbl <span class="built_in">arch</span>/x86/entry/syscalls/syscall_64.tbl</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/perf/arch/powerpc/entry/syscalls/syscall.tbl&#x27;</span> differs from latest version at <span class="string">&#x27;arch/powerpc/kernel/syscalls/syscall.tbl&#x27;</span></span><br><span class="line">diff -u tools/perf/arch/powerpc/entry/syscalls/syscall.tbl <span class="built_in">arch</span>/powerpc/kernel/syscalls/syscall.tbl</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/perf/arch/s390/entry/syscalls/syscall.tbl&#x27;</span> differs from latest version at <span class="string">&#x27;arch/s390/kernel/syscalls/syscall.tbl&#x27;</span></span><br><span class="line">diff -u tools/perf/arch/s390/entry/syscalls/syscall.tbl <span class="built_in">arch</span>/s390/kernel/syscalls/syscall.tbl</span><br><span class="line">Warning: Kernel ABI header at <span class="string">&#x27;tools/perf/arch/mips/entry/syscalls/syscall_n64.tbl&#x27;</span> differs from latest version at <span class="string">&#x27;arch/mips/kernel/syscalls/syscall_n64.tbl&#x27;</span></span><br><span class="line">diff -u tools/perf/arch/mips/entry/syscalls/syscall_n64.tbl <span class="built_in">arch</span>/mips/kernel/syscalls/syscall_n64.tbl</span><br><span class="line">Makefile.config:201: *** Error: flex is missing on this system, please install it.  Stop.</span><br><span class="line">make[1]: *** [sub-make] Error 2</span><br><span class="line">make: *** [all] Error 2</span><br></pre></td></tr></table></figure><br>错误原因是没有flex，安装flex，yum install flex，安装flex之后还需要安装bison，yum install bison，安装完毕后重新LIBBABELTRACE=1 LIBBABELTRACE_DIR=/usr/local make即可，前面加环境变量是因为需要在这个环境变量下编译才能使用perf data做转换。否则会报错perf should be compiled with environment variables LIBBABELTRACE=1 and LIBBA。<br>之后便可以用perf data将采集到的数据转成json，这样就可以看到进程中有哪些线程，可以针对单线程做profile。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ip-10-155-136-104 ~]<span class="comment"># ./linux/tools/perf/perf record -g -F 99 -p 3169  ## 3169是进程id</span></span><br><span class="line">[root@ip-10-155-136-104 ~]<span class="comment"># ./linux/tools/perf/perf data convert --force --to-json temp.json</span></span><br></pre></td></tr></table></figure>
<p>最后在写个脚本分析json文件即可。<br>参考：<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11921842/read-and-parse-perf-data">perf.data转成json</a>。<br><a target="_blank" rel="noopener" href="https://openlab-mu-internal.web.cern.ch/03_Documents/3_Technical_Documents/Technical_Reports/2011/Urs_Fassler_report.pdf">perf file format</a><br><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/tools/perf/Documentation/perf.data-file-format.txt">perf.data-file-format.txt</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/10/iptable%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B9%8B%E5%90%8Epod%E7%9A%84probability%E8%B6%8A%E6%9D%A5%E8%B6%8A%E5%A4%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/10/iptable%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B9%8B%E5%90%8Epod%E7%9A%84probability%E8%B6%8A%E6%9D%A5%E8%B6%8A%E5%A4%A7/" class="post-title-link" itemprop="url">iptable为什么之后pod的probability越来越大</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-10 20:03:47" itemprop="dateCreated datePublished" datetime="2022-02-10T20:03:47+08:00">2022-02-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:17" itemprop="dateModified" datetime="2023-07-16T17:11:17+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux-k8s/" itemprop="url" rel="index"><span itemprop="name">Linux k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p>项目集群是使用k8s管理的，流量分发使用的是iptable，据压测反馈说负载不均衡，吓得老夫赶紧去查看，发现原来是压测同学搞错了。在查询的过程中，发现iptable规则之后的probability越来越大，记录一下原因。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-1-34-89:/home/admin<span class="comment"># iptables -t nat -nL</span></span><br><span class="line">...</span><br><span class="line">Chain KUBE-SVC-7XZINH2IMK6FHKPK (2 references)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br><span class="line">KUBE-SEP-TOX5PBICM2IS3QEP  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.20000000019</span><br><span class="line">KUBE-SEP-BHWNMZ5XNYG7AESG  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.25000000000</span><br><span class="line">KUBE-SEP-OQLKQS2OMOJTYZF6  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.33332999982</span><br><span class="line">KUBE-SEP-EQOKMESPFMECIZJJ  all  --  0.0.0.0/0            0.0.0.0/0            statistic mode random probability 0.50000000000</span><br><span class="line">KUBE-SEP-GVLV4E5D2AGR4O5J  all  --  0.0.0.0/0            0.0.0.0/0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，总共5条记录，刚开始probability为0.2—-&gt;0.25—-&gt;0.33—-&gt;0.5—-无，为什么会这样。<br>因为流量进入之后，按照iptable规则转发，公共5条，所以第一条接收20%的流量。<br>剩下还有4条，下一条应该接收剩余流量的1/4，也就是25%。<br>剩下还有3条，下一条应该接收剩余流量的1/3，也就是33%。<br>……<br>最后一条因为只剩下它了，所有流量都会走这里，所以不用写probability。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/09/redis%20%E6%80%8E%E4%B9%88%E6%9F%A5%E8%AF%A2%E4%B8%80%E4%B8%AAkey%E6%9C%89%E5%A4%9A%E5%A4%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Fushen Ban">
      <meta itemprop="description" content="正在进化">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="拼图收集者">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/09/redis%20%E6%80%8E%E4%B9%88%E6%9F%A5%E8%AF%A2%E4%B8%80%E4%B8%AAkey%E6%9C%89%E5%A4%9A%E5%A4%A7/" class="post-title-link" itemprop="url">redis 怎么查询一个key有多大</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-09 17:06:27" itemprop="dateCreated datePublished" datetime="2022-01-09T17:06:27+08:00">2022-01-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-07-16 17:11:17" itemprop="dateModified" datetime="2023-07-16T17:11:17+08:00">2023-07-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <span id="more"></span>
<p>在项目开发过程中，最好是能估计出自己开发的功能要使用多大的redis内存</p>
<h1 id="使用redis自带的方法"><a href="#使用redis自带的方法" class="headerlink" title="使用redis自带的方法"></a>使用redis自带的方法</h1><h2 id="debug-object-key"><a href="#debug-object-key" class="headerlink" title="debug object key"></a>debug object key</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6006&gt; get testkey</span><br><span class="line"><span class="string">&quot;this is a test&quot;</span></span><br><span class="line">127.0.0.1:6006&gt; debug object testkey</span><br><span class="line">Value at:0x7f4f19e2b500 refcount:1 encoding:embstr serializedlength:15 lru:14327341 lru_seconds_idle:6</span><br></pre></td></tr></table></figure>
<ul>
<li>Value at: 内存地址</li>
<li>refcount: 引用次数</li>
<li>encoding: 编码类型</li>
<li>serializedlength: 序列化后的长度（注意这里的长度是序列化后的长度，保存为rdb文件时使用了该算法，不是真正存贮在内存的大小，不过可以用于比较）<h2 id="memory-usage"><a href="#memory-usage" class="headerlink" title="memory usage"></a>memory usage</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6006&gt; memory usage queuesSet</span><br><span class="line">(<span class="built_in">integer</span>) 1489075554</span><br></pre></td></tr></table></figure>
返回字节数</li>
</ul>
<h1 id="借助工具"><a href="#借助工具" class="headerlink" title="借助工具"></a>借助工具</h1><p>借助redis rdb tools工具，需要下载rdbtools，<code>pip install rdbtools</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">banfushen@banfushen:~$ redis-memory-for-key -p 6006 testkey</span><br><span class="line">Key                             testkey</span><br><span class="line">Bytes                           72</span><br><span class="line">Type                            string</span><br></pre></td></tr></table></figure>
<h1 id="使用脚本"><a href="#使用脚本" class="headerlink" title="使用脚本"></a>使用脚本</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"></span><br><span class="line">h = <span class="string">&#x27;localhost&#x27;</span></span><br><span class="line">p = <span class="number">6006</span></span><br><span class="line"></span><br><span class="line">rd = redis.Redis(host=h, port=p, decode_responses=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(rd.<span class="built_in">type</span>(<span class="string">&#x27;testkey&#x27;</span>), rd.strlen(<span class="string">&#x27;testkey&#x27;</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">banfushen@banfushen:~/gitlab/dbsync/test$ python redis_size.py </span><br><span class="line">(u<span class="string">&#x27;string&#x27;</span>, 14)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Fushen Ban</p>
  <div class="site-description" itemprop="description">正在进化</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">83</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Fushen Ban</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

  


    </div>
</body>
</html>
